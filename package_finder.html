<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Package Finder</title>
    <style>
      body {
        font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
        padding: 20px;
        transition: background-color 0.3s ease;
        background-color: black;
        color: white;
      }
      label {
        display: block;
        margin-top: 15px;
      }
      input[type="tel"] {
        width: 100%;
        padding: 8px;
        font-size: 1em;
        margin-top: 5px;
        box-sizing: border-box;
        border: 1px solid white;
        background-color: black;
        color: white;
      }
      #counter {
        margin-top: 20px;
        font-size: 1.1em;
        white-space: pre-line; /* preserve line breaks */
        color: white;
      }
      /* Make numbers inside #counter yellow */
      #counter::selection {
        color: yellow;
      }
    </style>
  </head>
  <body>
    <label for="inducted"><h1>Package Finder</h1></label>
    <label for="inducted"
      >Type the last 4 digits of the Tracking IDs:</label
    >
    <input type="tel" id="inducted" autocomplete="off" />
    <label for="scanned">Scan the QR Codes of the packages:</label>
    <input type="tel" id="scanned" autocomplete="off" />
    <div id="counter">
      Number of packages scanned: <span class="numbers">0</span>
    </div>
    <audio
      id="successSound"
      src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
      preload="auto"
    ></audio>
    <script>
      const inductedInput = document.getElementById("inducted");
      const scannedInput = document.getElementById("scanned");
      const successSound = document.getElementById("successSound");
      const counterDisplay = document.getElementById("counter");
      let scannedCount = 0;
      let foundList = [];

      // Format inducted input to add comma+space after every 4 digits automatically
      inductedInput.addEventListener("input", (event) => {
        let cursorPos = inductedInput.selectionStart;
        let rawValue = inductedInput.value;
        // Remove all non-digit characters (except commas and spaces) to preserve typed commas
        let digitsOnly = rawValue.replace(/[^0-9]/g, "");
        // Split into groups of 4
        let formatted = digitsOnly.match(/.{1,4}/g);
        if (formatted) {
          let newValue = formatted.join(", ");
          inductedInput.value = newValue;

          // Adjust cursor position to stay corrected
          let countCommasBeforeCursor = (rawValue.slice(0, cursorPos).match(/,/g) || []).length;
          // Calculate expected new cursor position
          let newCursorPos = cursorPos;
          if (cursorPos === rawValue.length) {
            // Cursor at end, just set after new value length
            newCursorPos = newValue.length;
          } else {
            // Approximate new position after format, can be improved if needed
            newCursorPos = newValue.length;
          }
          inductedInput.setSelectionRange(newCursorPos, newCursorPos);
        }
      });

      function isValidFormat(code) {
        const regex = /^IT\d{10}$/;
        return regex.test(code);
      }

      function checkMatch(scannedCode) {
        let inductedCodes = inductedInput.value
          .split(",")
          .map((s) => s.trim())
          .filter((s) => s.length === 4);

        if (scannedCode.length >= 4) {
          const last4 = scannedCode.slice(-4);
          if (inductedCodes.includes(last4)) {
            document.body.style.backgroundColor = "lightgreen";
            successSound.currentTime = 0;
            successSound.play();

            if (!foundList.includes(last4)) {
              foundList.push(last4);
            }
            // Remove found last4 from inducted codes
            inductedCodes = inductedCodes.filter((code) => code !== last4);
            inductedInput.value = inductedCodes.join(", ");

            return true;
          }
        }
        document.body.style.backgroundColor = "black";
        return false;
      }

      scannedInput.addEventListener("input", () => {
        const code = scannedInput.value.trim();
        if (code.length === 0) return;
        if (isValidFormat(code)) {
          scannedCount++;
          checkMatch(code);
          let foundText = foundList.map((c) => `${c} - Found`).join("\n");
          counterDisplay.innerHTML =
            `Number of packages scanned: <span style="color: yellow;">${scannedCount}</span>` +
            (foundList.length > 0
              ? `<br><br><span style="color: yellow;">${foundText.replace(/\n/g, "<br>")}</span>`
              : "");
          if (navigator.vibrate) {
            navigator.vibrate(500);
          }
        } else {
          document.body.style.backgroundColor = "black";
        }
        scannedInput.value = "";
      });
    </script>
  </body>
</html>
